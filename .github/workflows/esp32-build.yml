name: Build ESP32 Firmware

on:
  push:
    paths:
      - 'frozen/**'
      - 'modules/**'
      - 'partitions/**'
      - '.github/workflows/**'
    branches:
      - master
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04
    permissions:
      contents: write
    
    strategy:
      fail-fast: false
      matrix:
        board:
          - ESP32_GENERIC
          - ESP32_GENERIC_S2
          - ESP32_GENERIC_S3
          - ESP32_GENERIC_C3
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Install Build Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y git wget flex bison gperf python3 python3-pip \
            cmake ninja-build ccache libffi-dev libssl-dev dfu-util libusb-1.0-0
      
      - name: Cache ESP-IDF
        id: cache-esp-idf
        uses: actions/cache@v4
        with:
          path: |
            ~/esp-idf
            ~/.espressif
          key: esp-idf-v5.0.4-${{ runner.os }}-${{ hashFiles('**/.github/workflows/*.yml') }}
      
      - name: Setup ESP-IDF
        if: steps.cache-esp-idf.outputs.cache-hit != 'true'
        run: |
          echo "Installing ESP-IDF v5.0.4..."
          git clone --depth 1 --branch v5.0.4 --recursive \
            https://github.com/espressif/esp-idf.git ~/esp-idf
          cd ~/esp-idf
          ./install.sh esp32,esp32s2,esp32s3,esp32c3
      
      - name: Cache MicroPython
        id: cache-micropython
        uses: actions/cache@v4
        with:
          path: ~/micropython
          key: micropython-v1.22.0-${{ runner.os }}-${{ hashFiles('**/*.py') }}
      
      - name: Clone MicroPython
        if: steps.cache-micropython.outputs.cache-hit != 'true'
        run: |
          git clone --depth 1 --branch v1.22.0 \
            https://github.com/micropython/micropython.git ~/micropython
          cd ~/micropython/mpy-cross
          make
      
      - name: Init Submodules
        run: |
          cd ~/micropython/ports/esp32
          . ~/esp-idf/export.sh
          make submodules
      
      - name: Prepare Firmware Files
        run: |
          echo "=== Preparing TansuoDou Firmware ==="
          
          # å¤åˆ¶Frozenæ¨¡å—ï¼ˆæ‰€æœ‰è®¾å¤‡å…±ç”¨ï¼‰
          mkdir -p ~/micropython/ports/esp32/tansuodou_frozen
          cp frozen/*.py ~/micropython/ports/esp32/tansuodou_frozen/
          
          # å°†tansuodou_main.pyä¹ŸåŠ å…¥frozenæ¨¡å—ï¼ˆç¡®ä¿ç‰ˆæœ¬ä¸€è‡´æ€§ï¼‰
          cp modules/tansuodou_main.py ~/micropython/ports/esp32/tansuodou_frozen/
          
          echo "âœ… Frozen modules copied"
          
          # åˆ›å»ºæ¨¡å—ç›®å½•
          mkdir -p ~/micropython/ports/esp32/modules
          
          # æ ¹æ®è®¾å¤‡ç±»å‹å¤åˆ¶ä¸åŒçš„æ¨¡å—
          echo "ğŸ“¦ Copying modules for ${{ matrix.board }}..."
          
          # åŸºç¡€æ¨¡å—ï¼ˆæ‰€æœ‰è®¾å¤‡ï¼‰
          # tansuodou_main.py å·²ç§»è‡³frozenæ¨¡å—ï¼Œä¸å†æ”¾å…¥modulesç›®å½•
          cp modules/ota_manager.py ~/micropython/ports/esp32/modules/
          cp modules/ota_http_server.py ~/micropython/ports/esp32/modules/
          cp modules/config_portal.py ~/micropython/ports/esp32/modules/
          cp modules/dns_server.py ~/micropython/ports/esp32/modules/
          cp modules/device_web_server.py ~/micropython/ports/esp32/modules/
          echo "  âœ… Base modules (ota_manager, ota_http_server, config_portal, dns_server, device_web_server)"
          
          # ESP32ç‰¹æ®ŠåŠŸèƒ½ï¼ˆESP32/S2/S3æ”¯æŒè§¦æ‘¸ï¼ŒESP32æ”¯æŒéœå°”ï¼ŒESP32/S2æ”¯æŒDACï¼‰
          if [[ "${{ matrix.board }}" == "ESP32_GENERIC" ]] || \
             [[ "${{ matrix.board }}" == "ESP32_GENERIC_S2" ]] || \
             [[ "${{ matrix.board }}" == "ESP32_GENERIC_S3" ]]; then
            cp modules/esp32_special.py ~/micropython/ports/esp32/modules/
            echo "  âœ… ESP32 special features (touch, hall, DAC)"
          fi
          
          # è“ç‰™BLEï¼ˆESP32/S3/C3æ”¯æŒï¼‰
          if [[ "${{ matrix.board }}" == "ESP32_GENERIC" ]] || \
             [[ "${{ matrix.board }}" == "ESP32_GENERIC_S3" ]] || \
             [[ "${{ matrix.board }}" == "ESP32_GENERIC_C3" ]]; then
            cp modules/ble.py ~/micropython/ports/esp32/modules/
            echo "  âœ… Bluetooth BLE support"
          fi
          
          # USB HIDï¼ˆä»…S2/S3æ”¯æŒï¼‰
          if [[ "${{ matrix.board }}" == "ESP32_GENERIC_S2" ]] || \
             [[ "${{ matrix.board }}" == "ESP32_GENERIC_S3" ]]; then
            cp modules/usb_hid_helper.py ~/micropython/ports/esp32/modules/
            echo "  âœ… USB HID support (keyboard, mouse)"
          fi
          
          # æ‘„åƒå¤´ï¼ˆä»…S3æ”¯æŒï¼‰
          if [[ "${{ matrix.board }}" == "ESP32_GENERIC_S3" ]]; then
            cp modules/camera_helper.py ~/micropython/ports/esp32/modules/
            echo "  âœ… Camera support"
          fi
          
          # AIæ¨ç†ï¼ˆä»…S3æ”¯æŒï¼‰
          if [[ "${{ matrix.board }}" == "ESP32_GENERIC_S3" ]]; then
            cp modules/ai_helper.py ~/micropython/ports/esp32/modules/
            echo "  âœ… AI inference support (TFLite)"
          fi
          
          # æ™ºèƒ½å®¶å±…é«˜çº§åŠŸèƒ½ï¼ˆä»…S3æ”¯æŒï¼‰
          if [[ "${{ matrix.board }}" == "ESP32_GENERIC_S3" ]]; then
            cp modules/ha_advanced.py ~/micropython/ports/esp32/modules/
            echo "  âœ… Home Assistant advanced features"
          fi
          
          echo "ğŸ“Š Module count for ${{ matrix.board }}:"
          ls -la ~/micropython/ports/esp32/modules/*.py | wc -l
          
          mkdir -p ~/micropython/ports/esp32/modules/user_code/{lib,examples}
          cat > ~/micropython/ports/esp32/modules/user_code/examples/hello.py << 'EOF'
          print('Hello from TansuoDou IoT Platform!')
          EOF
          
          cp partitions/*.csv ~/micropython/ports/esp32/
          
          cat > ~/micropython/ports/esp32/boards/manifest_tansuodou.py << 'EOF'
          include("$(PORT_DIR)/boards/manifest.py")
          freeze("$(PORT_DIR)/tansuodou_frozen", (
              "version.py",
              "boot.py",
              "wifi_config_helper.py",
              "ide_helper.py",
              "tansuodou_main.py",
          ))
          EOF
          
          echo "=== âœ… Preparation Complete ==="
      
      - name: Build Firmware
        run: |
          cd ~/micropython/ports/esp32
          . ~/esp-idf/export.sh
          
          echo "=== Building ${{ matrix.board }} ==="
          
          if [ "${{ matrix.board }}" = "ESP32_GENERIC_S3" ]; then
            PARTITION="partitions-ota-8mb.csv"
          else
            PARTITION="partitions-ota-4mb.csv"
          fi
          
          make BOARD=${{ matrix.board }} clean || true
          
          make BOARD=${{ matrix.board }} \
            FROZEN_MANIFEST="$(pwd)/boards/manifest_tansuodou.py" \
            PART_SRC="$PARTITION" \
            CFLAGS_EXTRA="-Wno-error" \
            -j$(nproc) 2>&1 | tee build.log
          
          if [ ! -f "build-${{ matrix.board }}/firmware.bin" ]; then
            echo "Build failed!"
            tail -n 100 build.log
            exit 1
          fi
          
          SIZE=$(stat -c%s "build-${{ matrix.board }}/firmware.bin")
          SIZE_MB=$(echo "scale=2; $SIZE / 1024 / 1024" | bc)
          echo "Firmware size: ${SIZE_MB}MB"
      
      - name: Extract Version
        id: version
        run: |
          VERSION=$(grep 'FIRMWARE_VERSION = ' frozen/version.py | sed "s/.*'\(.*\)'.*/\1/")
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Firmware version: $VERSION"
      
      - name: Save Firmware
        run: |
          mkdir -p $GITHUB_WORKSPACE/binaries
          
          FILENAME="tansuodou-${{ matrix.board }}-${{ steps.version.outputs.version }}.bin"
          
          # å¤åˆ¶å›ºä»¶æ–‡ä»¶
          cp ~/micropython/ports/esp32/build-${{ matrix.board }}/firmware.bin $GITHUB_WORKSPACE/binaries/$FILENAME
          
          echo "Saved: $FILENAME"
          ls -lh $GITHUB_WORKSPACE/binaries/$FILENAME
      
      - name: Upload Firmware Artifact
        uses: actions/upload-artifact@v4
        with:
          name: firmware-${{ matrix.board }}
          path: binaries/tansuodou-${{ matrix.board }}-${{ steps.version.outputs.version }}.bin
          retention-days: 90

  release:
    needs: build
    runs-on: ubuntu-22.04
    permissions:
      contents: write
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Extract Version
        id: version
        run: |
          VERSION=$(grep 'FIRMWARE_VERSION = ' frozen/version.py | sed "s/.*'\(.*\)'.*/\1/")
          BUILD=$(grep 'FIRMWARE_BUILD = ' frozen/version.py | sed "s/.*'\(.*\)'.*/\1/")
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "build=$BUILD" >> $GITHUB_OUTPUT
          echo "tag=v$VERSION" >> $GITHUB_OUTPUT
          echo "Firmware version: $VERSION (Build: $BUILD)"
      
      - name: Download All Artifacts
        uses: actions/download-artifact@v4
        with:
          path: firmware-artifacts
      
      - name: Prepare Release Files
        run: |
          mkdir -p release-files binaries
          cp firmware-artifacts/firmware-ESP32_GENERIC/*.bin release-files/
          cp firmware-artifacts/firmware-ESP32_GENERIC_S2/*.bin release-files/
          cp firmware-artifacts/firmware-ESP32_GENERIC_S3/*.bin release-files/
          cp firmware-artifacts/firmware-ESP32_GENERIC_C3/*.bin release-files/
          cp release-files/*.bin binaries/
          ls -lh release-files/
      
      - name: Commit Firmware to Repository
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          git add binaries/*.bin
          
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "build: Release v${{ steps.version.outputs.version }} - All platforms"
            git push origin master
          fi
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          name: "æ¢ç´¢è±†å›ºä»¶ ${{ steps.version.outputs.version }}"
          body: |
            ## ğŸš€ æ¢ç´¢è±† ESP32 å›ºä»¶ ${{ steps.version.outputs.version }}
            
            **Build:** ${{ steps.version.outputs.build }}
            **æ„å»ºæ—¶é—´:** ${{ github.event.head_commit.timestamp }}
            
            ### ğŸ“ æ”¯æŒçš„ç¡¬ä»¶å¹³å°
            
            - âœ… ESP32 (4MB Flash)
            - âœ… ESP32-S2 (4MB Flash)
            - âœ… ESP32-S3 (8MB Flash)
            - âœ… ESP32-C3 (4MB Flash)
            
            ### ğŸ“– ä½¿ç”¨æ–¹æ³•
            
            1. è®¿é—® [æ¢ç´¢è±†ç‰©è”å¹³å°](https://tansuodou.com/firmware/flash)
            2. é€‰æ‹©å¯¹åº”çš„èŠ¯ç‰‡å‹å·
            3. ä¸‹è½½æœ¬ Release ä¸­çš„å›ºä»¶æ–‡ä»¶
            4. ä½¿ç”¨åœ¨çº¿çƒ§å½•å·¥å…·æˆ– esptool.py çƒ§å½•
            
            ### ğŸ”§ æ‰‹åŠ¨çƒ§å½•å‘½ä»¤
            
            ```bash
            # ESP32 / ESP32-S2 / ESP32-C3
            esptool.py --port COM3 write_flash 0x1000 tansuodou-XXX-${{ steps.version.outputs.version }}.bin
            
            # ESP32-S3
            esptool.py --port COM3 write_flash 0x0 tansuodou-ESP32_GENERIC_S3-${{ steps.version.outputs.version }}.bin
            ```
            
            ### ğŸ“ æ›´æ–°å†…å®¹
            
            ${{ github.event.head_commit.message }}
          files: release-files/*.bin
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
