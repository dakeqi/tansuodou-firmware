name: Build ESP32 Firmware

on:
  push:
    paths:
      - 'frozen/**'
      - 'modules/**'
      - 'partitions/**'
    branches:
      - master
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04
    permissions:
      contents: write
    
    strategy:
      fail-fast: false
      matrix:
        board:
          - ESP32_GENERIC
          - ESP32_GENERIC_S2
          - ESP32_GENERIC_S3
          - ESP32_GENERIC_C3
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Install Build Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y git wget flex bison gperf python3 python3-pip \
            cmake ninja-build ccache libffi-dev libssl-dev dfu-util libusb-1.0-0
      
      - name: Cache ESP-IDF
        id: cache-esp-idf
        uses: actions/cache@v4
        with:
          path: |
            ~/esp-idf
            ~/.espressif
          key: esp-idf-v5.0.4-${{ runner.os }}-${{ hashFiles('**/.github/workflows/*.yml') }}
      
      - name: Setup ESP-IDF
        if: steps.cache-esp-idf.outputs.cache-hit != 'true'
        run: |
          echo "Installing ESP-IDF v5.0.4..."
          git clone --depth 1 --branch v5.0.4 --recursive \
            https://github.com/espressif/esp-idf.git ~/esp-idf
          cd ~/esp-idf
          ./install.sh esp32,esp32s2,esp32s3,esp32c3
      
      - name: Cache MicroPython
        id: cache-micropython
        uses: actions/cache@v4
        with:
          path: ~/micropython
          key: micropython-v1.22.0-${{ runner.os }}-${{ hashFiles('**/*.py') }}
      
      - name: Clone MicroPython
        if: steps.cache-micropython.outputs.cache-hit != 'true'
        run: |
          git clone --depth 1 --branch v1.22.0 \
            https://github.com/micropython/micropython.git ~/micropython
          cd ~/micropython/mpy-cross
          make
      
      - name: Init Submodules
        run: |
          cd ~/micropython/ports/esp32
          . ~/esp-idf/export.sh
          make submodules
      
      - name: Prepare Firmware Files
        run: |
          echo "=== Preparing TansuoDou Firmware ==="
          
          mkdir -p ~/micropython/ports/esp32/tansuodou_frozen
          cp frozen/*.py ~/micropython/ports/esp32/tansuodou_frozen/
          echo "Frozen modules copied"
          
          mkdir -p ~/micropython/ports/esp32/modules
          cp modules/*.py ~/micropython/ports/esp32/modules/
          echo "Filesystem modules copied"
          
          mkdir -p ~/micropython/ports/esp32/modules/user_code/{lib,examples}
          
          cat > ~/micropython/ports/esp32/modules/user_code/examples/hello.py << 'EOF'
          print('Hello from TansuoDou IoT Platform!')
          EOF
          
          cp partitions/*.csv ~/micropython/ports/esp32/
          
          cat > ~/micropython/ports/esp32/boards/manifest_tansuodou.py << 'EOF'
          include("$(PORT_DIR)/boards/manifest.py")
          freeze("$(PORT_DIR)/tansuodou_frozen", (
              "boot.py",
              "wifi_config_helper.py",
              "ide_helper.py",
          ))
          EOF
          
          echo "=== Preparation Complete ==="
      
      - name: Build Firmware
        run: |
          cd ~/micropython/ports/esp32
          . ~/esp-idf/export.sh
          
          echo "=== Building ${{ matrix.board }} ==="
          
          if [ "${{ matrix.board }}" = "ESP32_GENERIC_S3" ]; then
            PARTITION="partitions-ota-8mb.csv"
          else
            PARTITION="partitions-ota-4mb.csv"
          fi
          
          make BOARD=${{ matrix.board }} clean || true
          
          make BOARD=${{ matrix.board }} \
            FROZEN_MANIFEST="$(pwd)/boards/manifest_tansuodou.py" \
            PART_SRC="$PARTITION" \
            CFLAGS_EXTRA="-Wno-error" \
            -j$(nproc) 2>&1 | tee build.log
          
          if [ ! -f "build-${{ matrix.board }}/firmware.bin" ]; then
            echo "Build failed!"
            tail -n 100 build.log
            exit 1
          fi
          
          SIZE=$(stat -c%s "build-${{ matrix.board }}/firmware.bin")
          SIZE_MB=$(echo "scale=2; $SIZE / 1024 / 1024" | bc)
          echo "Firmware size: ${SIZE_MB}MB"
      
      - name: Extract Version
        id: version
        run: |
          VERSION=$(grep 'FIRMWARE_VERSION = ' frozen/boot.py | sed 's/.*"\(.*\)".*/\1/')
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Firmware version: $VERSION"
      
      - name: Save Firmware
        run: |
          mkdir -p $GITHUB_WORKSPACE/binaries
          
          FILENAME="tansuodou-${{ matrix.board }}-v${{ steps.version.outputs.version }}.bin"
          
          cp ~/micropython/ports/esp32/build-${{ matrix.board }}/firmware.bin \
            $GITHUB_WORKSPACE/binaries/$FILENAME
          
          echo "Saved: $FILENAME"
          ls -lh $GITHUB_WORKSPACE/binaries/$FILENAME
      
      - name: Upload Firmware Artifact
        uses: actions/upload-artifact@v4
        with:
          name: firmware-${{ matrix.board }}
          path: binaries/tansuodou-${{ matrix.board }}-v${{ steps.version.outputs.version }}.bin
          retention-days: 90

  release:
    needs: build
    runs-on: ubuntu-22.04
    permissions:
      contents: write
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Extract Version
        id: version
        run: |
          VERSION=$(grep 'FIRMWARE_VERSION = ' frozen/boot.py | sed 's/.*"\(.*\)".*/\1/')
          BUILD=$(grep 'FIRMWARE_BUILD = ' frozen/boot.py | sed 's/.*"\(.*\)".*/\1/')
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "build=$BUILD" >> $GITHUB_OUTPUT
          echo "tag=v$VERSION" >> $GITHUB_OUTPUT
          echo "Firmware version: $VERSION (Build: $BUILD)"
      
      - name: Download All Artifacts
        uses: actions/download-artifact@v4
        with:
          path: firmware-artifacts
      
      - name: Prepare Release Files
        run: |
          mkdir -p release-files binaries
          cp firmware-artifacts/firmware-ESP32_GENERIC/*.bin release-files/
          cp firmware-artifacts/firmware-ESP32_GENERIC_S2/*.bin release-files/
          cp firmware-artifacts/firmware-ESP32_GENERIC_S3/*.bin release-files/
          cp firmware-artifacts/firmware-ESP32_GENERIC_C3/*.bin release-files/
          cp release-files/*.bin binaries/
          ls -lh release-files/
      
      - name: Commit Firmware to Repository
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          git add binaries/*.bin
          
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "build: Release v${{ steps.version.outputs.version }} - All platforms"
            git push origin master
          fi
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          name: "æ¢ç´¢è±†å›ºä»¶ ${{ steps.version.outputs.version }}"
          body: |
            ## ğŸš€ æ¢ç´¢è±† ESP32 å›ºä»¶ ${{ steps.version.outputs.version }}
            
            **Build:** ${{ steps.version.outputs.build }}
            **æ„å»ºæ—¶é—´:** ${{ github.event.head_commit.timestamp }}
            
            ### ğŸ“¦ æ”¯æŒçš„ç¡¬ä»¶å¹³å°
            
            - âœ… ESP32 (4MB Flash)
            - âœ… ESP32-S2 (4MB Flash)
            - âœ… ESP32-S3 (8MB Flash)
            - âœ… ESP32-C3 (4MB Flash)
            
            ### ğŸ“– ä½¿ç”¨æ–¹æ³•
            
            1. è®¿é—® [æ¢ç´¢è±†ç‰©è”å¹³å°](https://tansuodou.com/firmware/flash)
            2. é€‰æ‹©å¯¹åº”çš„èŠ¯ç‰‡å‹å·
            3. ä¸‹è½½æœ¬ Release ä¸­çš„å›ºä»¶æ–‡ä»¶
            4. ä½¿ç”¨åœ¨çº¿çƒ§å½•å·¥å…·æˆ– esptool.py çƒ§å½•
            
            ### ğŸ”§ æ‰‹åŠ¨çƒ§å½•å‘½ä»¤
            
            ```bash
            # ESP32 / ESP32-S2 / ESP32-C3
            esptool.py --port COM3 write_flash 0x1000 tansuodou-XXX-v${{ steps.version.outputs.version }}.bin
            
            # ESP32-S3
            esptool.py --port COM3 write_flash 0x0 tansuodou-ESP32_GENERIC_S3-v${{ steps.version.outputs.version }}.bin
            ```
            
            ### ğŸ“ æ›´æ–°å†…å®¹
            
            ${{ github.event.head_commit.message }}
          files: release-files/*.bin
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
